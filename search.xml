<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Hello World</title>
    <url>/2021/03/12/hello-world.html</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>
]]></content>
  </entry>
  <entry>
    <title>解决Centos虚拟机有线网卡消失</title>
    <url>/2021/03/12/linux/2021-03-12-centos-network-manager.html</url>
    <content><![CDATA[<blockquote>
<p>centos系统虚拟机的有线网卡突然消失，导致网络无法连接</p>
</blockquote>
<a id="more"></a>

<h6 id="出现的问题"><a href="#出现的问题" class="headerlink" title="出现的问题"></a>出现的问题</h6><ul>
<li><p>进入虚拟机，在终端命令<code>systemctl start network.service</code>重启网络服务报以下错误(ens33为有线网卡,不同版本可能不同, 如ens32)</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">Connection &#x27;ens33&#x27; is not available on device ens33 because device is strictly unmanaged</span><br></pre></td></tr></table></figure>
<h6 id="最佳解决"><a href="#最佳解决" class="headerlink" title="最佳解决"></a>最佳解决</h6></li>
<li><p>关闭NetworkManager可以起作用，但不推荐，有线网卡消失是因为网卡未加入托管导致，这里重新纳入托管为最佳解决办法。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">查看托管状态</span><br><span class="line">nmcli n</span><br><span class="line">显示 disabled 则为本文遇到的问题，如果是 enabled 则可以不用往下看了</span><br><span class="line">开启 托管</span><br><span class="line">nmcli n on</span><br><span class="line">重启网络管理</span><br><span class="line">systemctl restart NetworkManager</span><br></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>centos</tag>
      </tags>
  </entry>
  <entry>
    <title>composer的安装和使用</title>
    <url>/2016/06/12/php/2016-06-12-composer.html</url>
    <content><![CDATA[<h2 id="安装composer"><a href="#安装composer" class="headerlink" title="安装composer"></a>安装<code>composer</code></h2><ul>
<li><p>版本要求<code>php &gt;= 5.4</code> </p>
</li>
<li><p><a href="http://docs.phpcomposer.com/">官方文档地址</a></p>
</li>
<li><p>终端指令安装</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ php -r <span class="string">&quot;copy(&#x27;https://install.phpcomposer.com/installer&#x27;, &#x27;composer-setup.php&#x27;);&quot;</span></span><br><span class="line"></span><br><span class="line">$ php composer-setup.php</span><br><span class="line"></span><br><span class="line">$ php -r <span class="string">&quot;unlink(&#x27;composer-setup.php&#x27;);&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>全局配置</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo mv composer.phar /usr/<span class="built_in">local</span>/bin/composer</span><br></pre></td></tr></table></figure>
</li>
<li><p>更换镜像加速源</p>
<ul>
<li><p><code>packagist</code>中文镜像</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ composer config -g repo.packagist composer https://packagist.phpcomposer.com</span><br></pre></td></tr></table></figure>
</li>
<li><p>阿里云镜像</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ composer config -g repo.packagist composer https://mirrors.aliyun.com/composer/</span><br></pre></td></tr></table></figure>
</li>
<li><p>腾讯云镜像</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ composer config -g repos.packagist composer https://mirrors.cloud.tencent.com/composer/</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h2 id="使用composer"><a href="#使用composer" class="headerlink" title="使用composer"></a>使用<code>composer</code></h2><ul>
<li><p>添加包</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ composer require <span class="string">&quot;foo/bar:1.0.0&quot;</span></span><br></pre></td></tr></table></figure></li>
<li><p>移除包</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ composer require foo/bar</span><br></pre></td></tr></table></figure>
</li>
<li><p>重新加载配置</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ composer dump-autoload</span><br></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>php</category>
      </categories>
      <tags>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>php扩展库安装</title>
    <url>/2017/09/21/php/2017-09-21-php-extensions.html</url>
    <content><![CDATA[<a id="more"></a>

<h3 id="windows环境下PHP安装扩展"><a href="#windows环境下PHP安装扩展" class="headerlink" title="windows环境下PHP安装扩展"></a>windows环境下PHP安装扩展</h3><ul>
<li><p>通过phpinfo()函数，进行查看扩展是否已安装</p>
  <figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">echo</span> phpinfo();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>根据php版本前往官方网址下载对应的扩展库</p>
<p><a href="http://pecl.php.net/packages.php">下载地址</a></p>
<p>windows对应<code>dll</code>， nts非线程安全，ts线程安全，x64代表64位，x86代表32位。</p>
</li>
<li><p>将下载的扩展库文件放入对应的扩展库文件夹，修改php.ini, 以下以redis为例</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">extension=php_igbinary.dll</span><br><span class="line">extension=php_redis.dll</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="linux-centos-redhat-环境下PHP安装扩展"><a href="#linux-centos-redhat-环境下PHP安装扩展" class="headerlink" title="linux(centos/redhat)环境下PHP安装扩展"></a>linux(centos/redhat)环境下PHP安装扩展</h3><h6 id="方法一-源码安装"><a href="#方法一-源码安装" class="headerlink" title="方法一: 源码安装"></a>方法一: 源码安装</h6><ol>
<li><p>下载php版本对应的扩展源码包</p>
<ul>
<li><p>例如redis</p>
<p><code>http://pecl.php.net/package/redis</code></p>
</li>
</ul>
</li>
<li><p>解压进入源码目录</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ tar -zxvf redis.tar.gz</span><br><span class="line">   </span><br><span class="line">$ <span class="built_in">cd</span> redis</span><br><span class="line">   </span><br><span class="line">$ /usr/bin/phpize </span><br><span class="line">   </span><br><span class="line">$ ./configure --with-php-config=/usr/bin/php-config</span><br><span class="line">   </span><br><span class="line">$ make &amp;&amp; make install</span><br><span class="line">   </span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;extension=redis.so&quot;</span> &gt;&gt; /etc/php.ini</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h6 id="方法二-pecl扩展库安装"><a href="#方法二-pecl扩展库安装" class="headerlink" title="方法二: pecl扩展库安装"></a>方法二: pecl扩展库安装</h6><ul>
<li><p>终端执行指令</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pecl install -o -f redis </span><br><span class="line">  </span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;extension=redis.so&quot;</span> &gt;&gt; /etc/php.ini</span><br><span class="line">  </span><br></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>php</category>
      </categories>
      <tags>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>使用php接入app支付</title>
    <url>/2016/06/12/php/2021-03-10-app-pay.html</url>
    <content><![CDATA[<blockquote>
<p>使用php语言接入支付宝和微信的app支付, 基于<code>yansongda/pay</code>扩展包(非laravel版本) v2版本, laravel框架有单独的版本和使用方式</p>
</blockquote>
<a id="more"></a>

<h6 id="文档地址"><a href="#文档地址" class="headerlink" title="文档地址"></a>文档地址</h6><p><a href="https://pay.yansongda.cn/docs/v2/">https://pay.yansongda.cn/docs/v2/</a></p>
<h6 id="github地址"><a href="#github地址" class="headerlink" title="github地址"></a>github地址</h6><p><a href="https://github.com/yansongda/pay">https://github.com/yansongda/pay</a></p>
<h6 id="支付宝配置"><a href="#支付宝配置" class="headerlink" title="支付宝配置"></a>支付宝配置</h6><p>具体商户如何申请移动应用和绑定参考<a href="https://www.jianshu.com/p/c15db5fb187b">这里</a></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Yansongda</span>\<span class="title">Pay</span>\<span class="title">Pay</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Yansongda</span>\<span class="title">Pay</span>\<span class="title">Log</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PayController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$config</span> = [</span><br><span class="line">        <span class="string">&#x27;app_id&#x27;</span> =&gt; <span class="string">&#x27;2016082000295641&#x27;</span>,      <span class="comment">// 申请的移动应用appid</span></span><br><span class="line">        <span class="string">&#x27;notify_url&#x27;</span> =&gt; <span class="string">&#x27;http://yansongda.cn/notify.php&#x27;</span>,  <span class="comment">// 异步回调地址</span></span><br><span class="line">        <span class="string">&#x27;return_url&#x27;</span> =&gt; <span class="string">&#x27;http://yansongda.cn/return.php&#x27;</span>,  <span class="comment">// 同步回调地址 一般不用</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// ali_public_key是支付公钥， 不是应用公钥</span></span><br><span class="line">        <span class="string">&#x27;ali_public_key&#x27;</span> =&gt; <span class="string">&#x27;MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAuWJKrQ6SWvS6niI+4vEVZiYfjkCfLQfoFI2nCp9ZLDS42QtiL4Ccyx8scgc3nhVwmVRte8f57TFvGhvJD0upT4O5O/lRxmTjechXAorirVdAODpOu0mFfQV9y/T9o9hHnU+VmO5spoVb3umqpq6D/Pt8p25Yk852/w01VTIczrXC4QlrbOEe3sr1E9auoC7rgYjjCO6lZUIDjX/oBmNXZxhRDrYx4Yf5X7y8FRBFvygIE2FgxV4Yw+SL3QAa2m5MLcbusJpxOml9YVQfP8iSurx41PvvXUMo49JG3BDVernaCYXQCoUJv9fJwbnfZd7J5YByC+5KM4sblJTq7bXZWQIDAQAB&#x27;</span>,</span><br><span class="line">        <span class="comment">// 加密方式： **RSA2**  </span></span><br><span class="line">        <span class="string">&#x27;private_key&#x27;</span> =&gt; <span class="string">&#x27;MIIEpAIBAAKCAQEAs6+F2leOgOrvj9jTeDhb5q46GewOjqLBlGSs/bVL4Z3fMr3p+Q1Tux/6uogeVi/eHd84xvQdfpZ87A1SfoWnEGH5z15yorccxSOwWUI+q8gz51IWqjgZxhWKe31BxNZ+prnQpyeMBtE25fXp5nQZ/pftgePyUUvUZRcAUisswntobDQKbwx28VCXw5XB2A+lvYEvxmMv/QexYjwKK4M54j435TuC3UctZbnuynSPpOmCu45ZhEYXd4YMsGMdZE5/077ZU1aU7wx/gk07PiHImEOCDkzqsFo0Buc/knGcdOiUDvm2hn2y1XvwjyFOThsqCsQYi4JmwZdRa8kvOf57nwIDAQABAoIBAQCw5QCqln4VTrTvcW+msB1ReX57nJgsNfDLbV2dG8mLYQemBa9833DqDK6iynTLNq69y88ylose33o2TVtEccGp8Dqluv6yUAED14G6LexS43KtrXPgugAtsXE253ZDGUNwUggnN1i0MW2RcMqHdQ9ORDWvJUCeZj/AEafgPN8AyiLrZeL07jJz/uaRfAuNqkImCVIarKUX3HBCjl9TpuoMjcMhz/MsOmQ0agtCatO1eoH1sqv5Odvxb1i59c8Hvq/mGEXyRuoiDo05SE6IyXYXr84/Nf2xvVNHNQA6kTckj8shSi+HGM4mO1Y4Pbb7XcnxNkT0Inn6oJMSiy56P+CpAoGBAO1O+5FE1ZuVGuLb48cY+0lHCD+nhSBd66B5FrxgPYCkFOQWR7pWyfNDBlmO3SSooQ8TQXA25blrkDxzOAEGX57EPiipXr/hy5e+WNoukpy09rsO1TMsvC+v0FXLvZ+TIAkqfnYBgaT56ku7yZ8aFGMwdCPL7WJYAwUIcZX8wZ3dAoGBAMHWplAqhe4bfkGOEEpfs6VvEQxCqYMYVyR65K0rI1LiDZn6Ij8fdVtwMjGKFSZZTspmsqnbbuCE/VTyDzF4NpAxdm3cBtZACv1Lpu2Om+aTzhK2PI6WTDVTKAJBYegXaahBCqVbSxieR62IWtmOMjggTtAKWZ1P5LQcRwdkaB2rAoGAWnAPT318Kp7YcDx8whOzMGnxqtCc24jvk2iSUZgb2Dqv+3zCOTF6JUsV0Guxu5bISoZ8GdfSFKf5gBAo97sGFeuUBMsHYPkcLehM1FmLZk1Q+ljcx3P1A/ds3kWXLolTXCrlpvNMBSN5NwOKAyhdPK/qkvnUrfX8sJ5XK2H4J8ECgYAGIZ0HIiE0Y+g9eJnpUFelXvsCEUW9YNK4065SD/BBGedmPHRC3OLgbo8X5A9BNEf6vP7fwpIiRfKhcjqqzOuk6fueA/yvYD04v+Da2MzzoS8+hkcqF3T3pta4I4tORRdRfCUzD80zTSZlRc/h286Y2eTETd+By1onnFFe2X01mwKBgQDaxo4PBcLL2OyVT5DoXiIdTCJ8KNZL9+kV1aiBuOWxnRgkDjPngslzNa1bK+klGgJNYDbQqohKNn1HeFX3mYNfCUpuSnD2Yag53Dd/1DLO+NxzwvTu4D6DCUnMMMBVaF42ig31Bs0jI3JQZVqeeFzSET8fkoFopJf3G6UXlrIEAQ==&#x27;</span>,</span><br><span class="line">        <span class="comment">// 使用公钥证书模式，请配置下面两个参数，同时修改ali_public_key为以.crt结尾的支付宝公钥证书路径，如（./cert/alipayCertPublicKey_RSA2.crt）</span></span><br><span class="line">        <span class="comment">// &#x27;app_cert_public_key&#x27; =&gt; &#x27;./cert/appCertPublicKey.crt&#x27;, //应用公钥证书路径</span></span><br><span class="line">        <span class="comment">// &#x27;alipay_root_cert&#x27; =&gt; &#x27;./cert/alipayRootCert.crt&#x27;, //支付宝根证书路径</span></span><br><span class="line">        <span class="string">&#x27;log&#x27;</span> =&gt; [ <span class="comment">// optional</span></span><br><span class="line">            <span class="string">&#x27;file&#x27;</span> =&gt; <span class="string">&#x27;./logs/alipay.log&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;level&#x27;</span> =&gt; <span class="string">&#x27;info&#x27;</span>, <span class="comment">// 建议生产环境等级调整为 info，开发环境为 debug</span></span><br><span class="line">            <span class="string">&#x27;type&#x27;</span> =&gt; <span class="string">&#x27;single&#x27;</span>, <span class="comment">// optional, 可选 daily.</span></span><br><span class="line">            <span class="string">&#x27;max_file&#x27;</span> =&gt; <span class="number">30</span>, <span class="comment">// optional, 当 type 为 daily 时有效，默认 30 天</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&#x27;http&#x27;</span> =&gt; [ <span class="comment">// optional</span></span><br><span class="line">            <span class="string">&#x27;timeout&#x27;</span> =&gt; <span class="number">5.0</span>,</span><br><span class="line">            <span class="string">&#x27;connect_timeout&#x27;</span> =&gt; <span class="number">5.0</span>,</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&#x27;mode&#x27;</span> =&gt; <span class="string">&#x27;dev&#x27;</span>, <span class="comment">// optional,设置此参数，将进入沙箱模式</span></span><br><span class="line">    ];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 生成支付签名和参数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$order</span> = [</span><br><span class="line">            <span class="string">&#x27;out_trade_no&#x27;</span> =&gt; <span class="string">&#x27;213213211312&#x27;</span>,  <span class="comment">// 商户自己生成的内部唯一支付单号</span></span><br><span class="line">            <span class="string">&#x27;total_amount&#x27;</span> =&gt; <span class="string">&#x27;0.01&#x27;</span>,  <span class="comment">// 支付金额 单位元</span></span><br><span class="line">            <span class="string">&#x27;subject&#x27;</span> =&gt; <span class="string">&#x27;test subject - 测试&#x27;</span>,</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Pay::alipay(<span class="keyword">$this</span>-&gt;config)-&gt;app(<span class="variable">$order</span>)-&gt;getContent();</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 异步回调</span></span><br><span class="line">     <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">notify</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 验签</span></span><br><span class="line">        <span class="variable">$alipay</span> = Pay::alipay(<span class="keyword">$this</span>-&gt;config);</span><br><span class="line">        <span class="variable">$data</span>   = <span class="variable">$alipay</span>-&gt;verify();</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$out_trade_no</span>   = <span class="variable">$data</span>-&gt;out_trade_no;  <span class="comment">// 商户自己生成的内部唯一支付单号</span></span><br><span class="line">        <span class="variable">$total_amount</span>   = <span class="variable">$data</span>-&gt;total_amount;     <span class="comment">// 支付金额 单位元</span></span><br><span class="line">        <span class="variable">$trade_no</span>       = <span class="variable">$data</span>-&gt;trade_no;  <span class="comment">// 交易流水号</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 发起退款申请</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">refund</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$refund_data</span> = [</span><br><span class="line">            <span class="string">&#x27;type&#x27;</span>           =&gt; <span class="string">&#x27;app&#x27;</span>,  <span class="comment">// 标识为app 必填为app</span></span><br><span class="line">            <span class="string">&#x27;trade_no&#x27;</span>       =&gt; <span class="string">&#x27;2020123121212&#x27;</span>, <span class="comment">// 原支付交易流水号</span></span><br><span class="line">            <span class="string">&#x27;out_request_no&#x27;</span> =&gt; <span class="string">&#x27;3213213131213&#x27;</span>,  <span class="comment">// 商户自己生成的内部唯一退款单号</span></span><br><span class="line">            <span class="string">&#x27;refund_amount&#x27;</span>  =&gt; <span class="string">&#x27;0.01&#x27;</span>,  <span class="comment">// 退款金额 单位元</span></span><br><span class="line">        ];</span><br><span class="line">        <span class="variable">$result</span> =  Pay::alipay(<span class="keyword">$this</span>-&gt;config)-&gt;refund(<span class="variable">$refund_data</span>);</span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">string</span>)<span class="variable">$result</span>-&gt;code !== <span class="string">&#x27;10000&#x27;</span>) &#123;</span><br><span class="line">            <span class="comment">// 接口调用失败</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="built_in">Exception</span>(<span class="variable">$result</span>-&gt;msg);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 接口调用成功</span></span><br><span class="line">        &#125;       </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 退款查询</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">query_refund</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$data</span> = [ </span><br><span class="line">            <span class="string">&#x27;type&#x27;</span>           =&gt; <span class="string">&#x27;app&#x27;</span>, <span class="comment">// 标识为app 必填为app</span></span><br><span class="line">            <span class="string">&#x27;out_trade_no&#x27;</span>   =&gt; <span class="string">&#x27;213213211312&#x27;</span>, <span class="comment">// 原支付订单的内部唯一单号</span></span><br><span class="line">            <span class="string">&#x27;out_request_no&#x27;</span> =&gt; <span class="string">&#x27;3213213131213&#x27;</span>,  <span class="comment">// 商户自己生成的内部唯一退款单号</span></span><br><span class="line">        ];</span><br><span class="line">        <span class="variable">$result</span> = Pay::alipay(<span class="keyword">$this</span>-&gt;config)-&gt;find(<span class="variable">$data</span>, <span class="string">&#x27;refund&#x27;</span>);   </span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">string</span>)<span class="variable">$result</span>-&gt;code !== <span class="string">&#x27;10000&#x27;</span>)&#123;</span><br><span class="line">            <span class="comment">// 未查到或者到账失败</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 查到到账信息</span></span><br><span class="line">            <span class="variable">$trade_no</span> = <span class="variable">$result</span>-&gt;trade_no;  <span class="comment">// 退款交易单号</span></span><br><span class="line">            <span class="variable">$money</span> = <span class="variable">$result</span>-&gt;refund_amount;  <span class="comment">// 退款金额 单位元</span></span><br><span class="line">        &#125;              </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h6 id="微信支付配置"><a href="#微信支付配置" class="headerlink" title="微信支付配置"></a>微信支付配置</h6><ul>
<li>具体如何申请商户号和app支付功能参考<a href="https://jingyan.baidu.com/article/02027811706ea61bcd9ce54c.html">这里</a></li>
<li>具体配置参考<a href="https://app.applebyme.cn/doc/guide/wxpay.cshtml">这里</a></li>
</ul>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Yansongda</span>\<span class="title">Pay</span>\<span class="title">Pay</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Yansongda</span>\<span class="title">Pay</span>\<span class="title">Log</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PayController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$config</span> = [</span><br><span class="line">        <span class="string">&#x27;appid&#x27;</span> =&gt; <span class="string">&#x27;wxb3fxxxxxxxxxxx&#x27;</span>, <span class="comment">// APP APPID</span></span><br><span class="line">        <span class="comment">//&#x27;app_id&#x27; =&gt; &#x27;wxb3fxxxxxxxxxxx&#x27;, // 公众号 APPID</span></span><br><span class="line">        <span class="comment">//&#x27;miniapp_id&#x27; =&gt; &#x27;wxb3fxxxxxxxxxxx&#x27;, // 小程序 APPID</span></span><br><span class="line">        <span class="string">&#x27;mch_id&#x27;</span> =&gt; <span class="string">&#x27;14577xxxx&#x27;</span>,  <span class="comment">// 支付商户号id</span></span><br><span class="line">        <span class="string">&#x27;key&#x27;</span> =&gt; <span class="string">&#x27;mF2suE9sU6Mk1Cxxxxxxxxxxx&#x27;</span>,  <span class="comment">// api支付秘钥</span></span><br><span class="line">        <span class="string">&#x27;notify_url&#x27;</span> =&gt; <span class="string">&#x27;http://yanda.net.cn/notify.php&#x27;</span>,  <span class="comment">// 异步回调地址</span></span><br><span class="line">    </span><br><span class="line">        <span class="comment">// api支付证书</span></span><br><span class="line">        <span class="string">&#x27;cert_client&#x27;</span> =&gt; <span class="string">&#x27;./cert/apiclient_cert.pem&#x27;</span>, <span class="comment">// optional，退款等情况时用到</span></span><br><span class="line">        <span class="string">&#x27;cert_key&#x27;</span> =&gt; <span class="string">&#x27;./cert/apiclient_key.pem&#x27;</span>,<span class="comment">// optional，退款等情况时用到</span></span><br><span class="line">    </span><br><span class="line">        <span class="string">&#x27;log&#x27;</span> =&gt; [ <span class="comment">// optional</span></span><br><span class="line">            <span class="string">&#x27;file&#x27;</span> =&gt; <span class="string">&#x27;./logs/wechat.log&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;level&#x27;</span> =&gt; <span class="string">&#x27;info&#x27;</span>, <span class="comment">// 建议生产环境等级调整为 info，开发环境为 debug</span></span><br><span class="line">            <span class="string">&#x27;type&#x27;</span> =&gt; <span class="string">&#x27;single&#x27;</span>, <span class="comment">// optional, 可选 daily.</span></span><br><span class="line">            <span class="string">&#x27;max_file&#x27;</span> =&gt; <span class="number">30</span>, <span class="comment">// optional, 当 type 为 daily 时有效，默认 30 天</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&#x27;http&#x27;</span> =&gt; [ <span class="comment">// optional</span></span><br><span class="line">            <span class="string">&#x27;timeout&#x27;</span> =&gt; <span class="number">5.0</span>,</span><br><span class="line">            <span class="string">&#x27;connect_timeout&#x27;</span> =&gt; <span class="number">5.0</span>,</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&#x27;mode&#x27;</span> =&gt; <span class="string">&#x27;dev&#x27;</span>, <span class="comment">// optional, dev/hk;当为 `hk` 时，为香港 gateway。</span></span><br><span class="line">    ];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 生成支付签名和参数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$order</span> = [</span><br><span class="line">            <span class="string">&#x27;out_trade_no&#x27;</span> =&gt; <span class="string">&#x27;213213211312&#x27;</span>,  <span class="comment">// 商户自己生成的内部唯一支付单号</span></span><br><span class="line">            <span class="string">&#x27;total_fee&#x27;</span> =&gt; <span class="string">&#x27;1&#x27;</span>,  <span class="comment">// 支付金额 单位分</span></span><br><span class="line">            <span class="string">&#x27;body&#x27;</span> =&gt; <span class="string">&#x27;test subject - 测试&#x27;</span>,</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Pay::wechat(<span class="keyword">$this</span>-&gt;config)-&gt;app(<span class="variable">$order</span>)-&gt;getContent();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 异步回调</span></span><br><span class="line">     <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">notify</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 验签</span></span><br><span class="line">        <span class="variable">$wechat</span> = Pay::wechat(<span class="keyword">$this</span>-&gt;config);</span><br><span class="line">        <span class="variable">$data</span>   = <span class="variable">$wechat</span>-&gt;verify();</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$out_trade_no</span>   = <span class="variable">$data</span>-&gt;out_trade_no;  <span class="comment">// 商户自己生成的内部唯一支付单号</span></span><br><span class="line">        <span class="variable">$total_fee</span>      = <span class="variable">$data</span>-&gt;total_fee;     <span class="comment">// 支付金额 单位分</span></span><br><span class="line">        <span class="variable">$transaction_id</span> = <span class="variable">$data</span>-&gt;transaction_id;  <span class="comment">// 交易流水号</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 发起退款申请</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">refund</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$refund_data</span> = [</span><br><span class="line">            <span class="string">&#x27;type&#x27;</span>           =&gt; <span class="string">&#x27;app&#x27;</span>,  <span class="comment">// 标识为app 必填为app</span></span><br><span class="line">            <span class="string">&#x27;transaction_id&#x27;</span> =&gt; <span class="string">&#x27;2020123121212&#x27;</span>, <span class="comment">// 原支付交易流水号</span></span><br><span class="line">            <span class="string">&#x27;out_refund_no&#x27;</span>  =&gt; <span class="string">&#x27;3213213131213&#x27;</span>,  <span class="comment">// 商户自己生成的内部唯一退款单号</span></span><br><span class="line">            <span class="string">&#x27;refund_fee&#x27;</span>     =&gt; <span class="string">&#x27;1&#x27;</span>,  <span class="comment">// 退款金额 单位分</span></span><br><span class="line">            <span class="string">&#x27;total_fee&#x27;</span>      =&gt; <span class="string">&#x27;1&#x27;</span>,  <span class="comment">// 原支付金额 单位分</span></span><br><span class="line">            <span class="string">&#x27;refund_desc&#x27;</span>    =&gt; <span class="string">&#x27;退款测试&#x27;</span>,  </span><br><span class="line">        ];</span><br><span class="line">        <span class="variable">$result</span> =  Pay::wechat(<span class="keyword">$this</span>-&gt;config)-&gt;refund(<span class="variable">$refund_data</span>);</span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">string</span>)<span class="variable">$result</span>-&gt;return_code !== <span class="string">&#x27;SUCCESS&#x27;</span>) &#123;</span><br><span class="line">            <span class="comment">// 接口调用失败</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="built_in">Exception</span>(<span class="variable">$result</span>-&gt;return_msg);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 接口调用成功</span></span><br><span class="line">        &#125;       </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 退款查询</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">query_refund</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$data</span> = [ </span><br><span class="line">            <span class="string">&#x27;type&#x27;</span>           =&gt; <span class="string">&#x27;app&#x27;</span>, <span class="comment">// 标识为app 必填为app</span></span><br><span class="line">            <span class="string">&#x27;out_refund_no&#x27;</span>  =&gt; <span class="string">&#x27;3213213131213&#x27;</span>,  <span class="comment">// 商户自己生成的内部唯一退款单号</span></span><br><span class="line">        ];</span><br><span class="line">        <span class="variable">$result</span> = Pay::wechat(<span class="keyword">$this</span>-&gt;config)-&gt;find(<span class="variable">$data</span>, <span class="string">&#x27;refund&#x27;</span>);   </span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">string</span>)<span class="variable">$result</span>-&gt;return_code !== <span class="string">&#x27;SUCCESS&#x27;</span>)&#123;</span><br><span class="line">            <span class="comment">// 未查到或者到账失败</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 查到到账信息 多笔根据下标取, 下标从0开始</span></span><br><span class="line">            <span class="variable">$trade_no</span> = <span class="variable">$result</span>-&gt;refund_id_0;  <span class="comment">// 退款交易单号</span></span><br><span class="line">            <span class="variable">$money</span> = <span class="variable">$result</span>-&gt;refund_fee_0;  <span class="comment">// 退款金额 单位分</span></span><br><span class="line">        &#125;              </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>php</category>
      </categories>
      <tags>
        <tag>php</tag>
        <tag>app</tag>
      </tags>
  </entry>
</search>
